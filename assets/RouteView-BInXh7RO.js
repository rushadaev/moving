import{d as H,r as l,ab as G,a8 as K,h as r,ac as te,o as C,e as o,b as u,i as k,G as R,a1 as Z,a6 as pe,_ as J,t as B,Z as fe,u as ge,c as P,a0 as me,a as x,af as he,g as we,ag as ye,ah as X,ai as Y,j as Ce,aj as Me,ak as ee,H as _e,F as be}from"./index-DJR3TMNh.js";import{G as Ae,C as xe,M as ke}from"./ChangeMoversModal-Yw62wOKo.js";import{a as Re,N as $e}from"./FormItem-Ctc2y8i8.js";import"./Button.vue_vue_type_style_index_0_scoped_39e4a762_lang-C9dc366O.js";const Fe={class:"add-point-form"},qe={class:"modal-footer"},Ue=H({__name:"AddUnloadingPointModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","add","cancel"],setup(U,{emit:b}){const c=U,M=b,v=l(c.modelValue),w=l(!1),F=l(),d=l({address:""}),y={address:{required:!0,message:"Please enter an address",trigger:["blur","change"]}};G(()=>c.modelValue,m=>{v.value=m,m&&(d.value.address="")}),G(v,m=>{M("update:modelValue",m)});const $=()=>{v.value=!1,M("cancel")},D=async()=>{var m;try{await((m=F.value)==null?void 0:m.validate()),M("add",d.value.address),v.value=!1}catch{}};return(m,p)=>(C(),K(te,{show:v.value,"onUpdate:show":p[1]||(p[1]=A=>v.value=A),title:"Add unloading point"},{footer:r(()=>[o("div",qe,[u(R,{type:"secondary",onClick:$,disabled:w.value},{default:r(()=>p[2]||(p[2]=[k(" Cancel ")])),_:1},8,["disabled"]),u(R,{onClick:D,disabled:w.value||!d.value.address,loading:w.value},{default:r(()=>p[3]||(p[3]=[k(" Add ")])),_:1},8,["disabled","loading"])])]),default:r(()=>[o("div",Fe,[u(Z($e),{ref_key:"formRef",ref:F,model:d.value,rules:y},{default:r(()=>[u(Z(Re),{label:"Address",path:"address"},{default:r(()=>[u(Z(pe),{value:d.value.address,"onUpdate:value":p[0]||(p[0]=A=>d.value.address=A),placeholder:"Address",disabled:w.value},null,8,["value","disabled"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["show"]))}}),De=J(Ue,[["__scopeId","data-v-6e4fd958"]]),Se={class:"approval-content"},Pe={class:"approval-message"},Be={class:"modal-footer"},Ee=H({__name:"ApprovalActionModal",props:{show:{type:Boolean,default:!1},title:{type:String,default:"Approver action"},message:{type:String,default:"Are you sure that you want to change number of movers?"}},emits:["update:show","confirm","cancel"],setup(U,{emit:b}){const c=U,M=b,v=l(c.show);G(()=>c.show,d=>{v.value=d}),G(v,d=>{M("update:show",d)});const w=()=>{M("update:show",!1),M("cancel")},F=()=>{M("confirm"),M("update:show",!1)};return(d,y)=>(C(),K(te,{show:v.value,"onUpdate:show":y[0]||(y[0]=$=>v.value=$),title:U.title},{footer:r(()=>[o("div",Be,[u(R,{type:"secondary",onClick:w},{default:r(()=>y[1]||(y[1]=[k(" Cancel ")])),_:1}),u(R,{onClick:F},{default:r(()=>y[2]||(y[2]=[k(" Confirm ")])),_:1})])]),default:r(()=>[o("div",Se,[o("p",Pe,B(U.message),1)])]),_:1},8,["show","title"]))}}),Ne=J(Ee,[["__scopeId","data-v-25d88e56"]]),Ie={class:"route-view"},Ve={key:0,class:"flex items-center justify-center h-screen"},Te={key:1,class:"p-4"},Oe={class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"},Ze={key:2,class:"route-content"},Ge={class:"map-container"},Le={class:"info-cards"},je={class:"info-card"},ze={class:"info-value"},He={class:"info-card"},Ke={class:"info-value"},Je={class:"executor-info"},Qe={class:"executor-details"},We={class:"executor-name"},Xe={class:"overlay-content"},Ye={class:"content-block"},et={key:0,class:"points-list"},tt={class:"point-address"},st=["onClick"],at={key:1,class:"empty-points"},ot={class:"action-buttons"},lt=H({__name:"RouteView",setup(U){const b=Ce(),c=fe(),M=ge(),v=l(!1),w=l(""),F=l({lat:40.7128,lng:-74.006}),d=l(12),y=l("--"),$=l("--:--"),D=l(!0),m=l(!1),p=l(!1),A=l(!1),S=l(null),Q=l(2),f=P(()=>c.selectedRequest),se=l("Name and surname"),I=l(2),ae=P(()=>{var e;return(e=f.value)!=null&&e.departure_time?new Date(f.value.departure_time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--"}),oe=P(()=>$.value),g=l([]),L=P(()=>{var t,n;const a=[],e=(n=(t=f.value)==null?void 0:t.addresses)==null?void 0:n.find(i=>i.type==="loading");return e&&a.push({position:{lat:parseFloat(e.latitude),lng:parseFloat(e.longitude)},title:"Loading Point",icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#5D87EE">
            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
          </svg>
        `)},address:e.address,type:"loading"}),g.value.forEach(i=>{i.latitude&&i.longitude&&a.push({position:{lat:i.latitude,lng:i.longitude},title:"Unloading Point",icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#F97066">
              <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
            </svg>
          `)},address:i.address,type:"unloading"})}),a}),E=P(()=>{var e,t;const a=(t=(e=f.value)==null?void 0:e.addresses)==null?void 0:t.find(n=>n.type==="loading");return a?{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)}:null}),j=P(()=>{if(g.value.length===0)return null;const a=g.value[g.value.length-1];return!a.latitude||!a.longitude?null:{lat:a.latitude,lng:a.longitude}}),le=async a=>{g.value=g.value.filter(e=>e.id!==a),await W(),z()},ne=async a=>{const e=await Me.geocodeAddress(a);if(e){const t={id:Date.now(),address:e.formattedAddress,latitude:e.latitude,longitude:e.longitude};g.value.push(t),await W(),await z(),p.value=!1}else w.value="Could not find location for this address"},de=()=>{S.value="movers",A.value=!0},ie=()=>{S.value="point",A.value=!0},ue=()=>{S.value==="movers"?m.value=!0:S.value==="point"&&(p.value=!0),S.value=null},re=async a=>{var e;I.value=a,Q.value=a,(e=f.value)!=null&&e.id&&await c.updateMoversCount(f.value.id,a),m.value=!1},ce=()=>{b.push("/moving-history")},W=async()=>{var a,e;if((a=f.value)!=null&&a.id)try{const t=[],n=(e=f.value.addresses)==null?void 0:e.find(h=>h.type==="loading");n&&t.push({address:n.address,latitude:n.latitude,longitude:n.longitude,type:"loading",order:0}),g.value.forEach((h,s)=>{var _,V;t.push({address:h.address,latitude:((_=h.latitude)==null?void 0:_.toString())||"",longitude:((V=h.longitude)==null?void 0:V.toString())||"",type:s===0?"unloading":"intermediate",order:s+1})}),console.log("Updating addresses on backend:",t);let i=0;if(E.value&&g.value.length>0){const h=[E.value];g.value.forEach(s=>{s.latitude&&s.longitude&&h.push({lat:s.latitude,lng:s.longitude})});for(let s=0;s<h.length-1;s++){const _=await ee.calculateRoute(h[s],h[s+1]);_&&(i+=_.distance/1609.34)}}const N={addresses:t,distance:Math.round(i*10)/10};console.log("Updating with distance (miles):",N.distance),await c.updateRequest(f.value.id,N)&&await c.getRequestById(f.value.id)}catch(t){console.error("Failed to update addresses:",t),w.value="Failed to update addresses on server"}},z=async()=>{if(!E.value||!j.value){y.value="--",$.value="--:--";return}const a=await ee.calculateRoute(E.value,j.value);if(a){const e=(a.distance/1e3).toFixed(1);y.value=`${e} km`;const t=Math.round(a.duration/60),n=Math.floor(t/60),i=t%60;$.value=n>0?`${n}h ${i}m`:`${i}m`}},ve=a=>{if(a&&a.duration&&a.distance){const e=Math.round(a.duration/60),t=Math.floor(e/60),n=e%60;$.value=t>0?`${t}h ${n}m`:`${n}m`;const i=(a.distance/1e3).toFixed(1);y.value=`${i} km`}};return me(async()=>{var a,e,t,n,i,N;if(!M.isAuthenticated){b.push("/");return}v.value=!0;try{const q=Number(b.currentRoute.value.query.id);if(!q&&!c.selectedRequest){b.push("/requests");return}if(q&&(!c.selectedRequest||c.selectedRequest.id!==q)&&await c.getRequestById(q),!c.selectedRequest){b.push("/requests");return}console.log("All addresses from request:",(a=f.value)==null?void 0:a.addresses),(t=(e=f.value)==null?void 0:e.addresses)==null||t.forEach((s,_)=>{console.log(`Address ${_}: type="${s.type}", address="${s.address}"`)});const h=((i=(n=f.value)==null?void 0:n.addresses)==null?void 0:i.filter(s=>s.type==="unloading"||s.type==="intermediate"))||[];if(console.log("Filtered unloading addresses:",h),g.value=h.map((s,_)=>({id:s.id||Date.now()+_,address:s.address,latitude:parseFloat(s.latitude),longitude:parseFloat(s.longitude)})),console.log("Unloading points after mapping:",g.value),I.value=((N=f.value)==null?void 0:N.movers_count)||2,Q.value=I.value,L.value.length>0){const s={north:-90,south:90,east:-180,west:180};L.value.forEach(O=>{s.north=Math.max(s.north,O.position.lat),s.south=Math.min(s.south,O.position.lat),s.east=Math.max(s.east,O.position.lng),s.west=Math.min(s.west,O.position.lng)}),F.value={lat:(s.north+s.south)/2,lng:(s.east+s.west)/2};const _=s.north-s.south,V=s.east-s.west,T=Math.max(_,V);T<.01?d.value=15:T<.05?d.value=13:T<.1?d.value=12:T<.5?d.value=10:d.value=8}await z()}catch(q){console.error("Error loading route view:",q),w.value="Failed to load route data"}finally{v.value=!1}}),(a,e)=>(C(),x("div",Ie,[u(_e,{title:"Tracking"}),v.value?(C(),x("main",Ve,e[7]||(e[7]=[o("p",null,"Loading route data...",-1)]))):w.value?(C(),x("main",Te,[o("div",Oe,[o("p",null,B(w.value),1)]),u(R,{onClick:e[0]||(e[0]=t=>Z(b).push("/requests"))},{default:r(()=>e[8]||(e[8]=[k(" Return to Requests ")])),_:1})])):(C(),x("main",Ze,[o("div",Ge,[u(Ae,{center:F.value,zoom:d.value,height:"100%","show-route":!0,origin:E.value,destination:j.value,onRouteCalculated:ve},{default:r(()=>[(C(!0),x(X,null,Y(L.value,t=>(C(),K(ke,{key:t.title+t.address,position:t.position,icon:t.icon},null,8,["position","icon"]))),128))]),_:1},8,["center","zoom","origin","destination"]),o("div",Le,[o("div",je,[e[9]||(e[9]=o("span",{class:"info-label"},"Departure time",-1)),o("span",ze,B(ae.value),1)]),o("div",He,[e[10]||(e[10]=o("span",{class:"info-label"},"Travel time",-1)),o("span",Ke,B(oe.value),1)])]),o("div",Je,[o("div",Qe,[e[11]||(e[11]=o("span",{class:"executor-label"},"Executor",-1)),o("span",We,B(se.value),1)]),u(R,{"small-button":!0,onClick:e[1]||(e[1]=()=>{})},{default:r(()=>e[12]||(e[12]=[k(" Status ")])),_:1})]),o("div",{class:he(["bottom-overlay",{collapsed:!D.value}])},[o("div",{class:"drag-handle",onClick:e[2]||(e[2]=t=>D.value=!D.value)},e[13]||(e[13]=[o("div",{class:"handle-bar"},null,-1)])),we(o("div",Xe,[o("div",Ye,[e[15]||(e[15]=o("h3",{class:"block-title"},"Unloading points",-1)),g.value.length>0?(C(),x("div",et,[(C(!0),x(X,null,Y(g.value,t=>(C(),x("div",{key:t.id,class:"point-item"},[o("span",tt,B(t.address),1),o("button",{class:"remove-button",onClick:n=>le(t.id),"aria-label":"Remove point"}," × ",8,st)]))),128))])):(C(),x("div",at,e[14]||(e[14]=[o("p",{class:"empty-text"},"No unloading points added yet",-1)])))]),o("div",ot,[u(R,{onClick:ie,"full-width":!0},{default:r(()=>e[16]||(e[16]=[k(" Add point ")])),_:1}),u(R,{onClick:de,"full-width":!0,class:"secondary-action"},{default:r(()=>e[17]||(e[17]=[k(" Change number of movers ")])),_:1}),u(R,{onClick:ce,"full-width":!0,class:"secondary-action"},{default:r(()=>e[18]||(e[18]=[k(" View moving history ")])),_:1})])],512),[[ye,D.value]])],2)])])),u(xe,{show:m.value,"onUpdate:show":e[3]||(e[3]=t=>m.value=t),initialCount:I.value,onConfirm:re},null,8,["show","initialCount"]),u(De,{show:p.value,"onUpdate:show":e[4]||(e[4]=t=>p.value=t),onAdd:ne},null,8,["show"]),u(Ne,{show:A.value,"onUpdate:show":e[5]||(e[5]=t=>A.value=t),message:S.value==="movers"?"Are you sure that you want to change number of movers?":"Are you sure that you want to add a new unloading point?",onConfirm:ue,onCancel:e[6]||(e[6]=t=>A.value=!1)},null,8,["show","message"]),u(be)]))}}),rt=J(lt,[["__scopeId","data-v-b4bb1102"]]);export{rt as default};
