import{d as A,o as d,a as p,e as o,t as _,f as B,a0 as J,_ as S,r,U as X,a1 as N,Z as V,h as g,a2 as Y,b as v,i as k,G as C,R as qe,u as he,c as L,a3 as ye,a4 as we,V as D,H as Re,a5 as be,g as ke,a6 as Ce,a7 as G,a8 as W,j as _e,F as Me}from"./index-C2p0S5r-.js";import{G as $e,C as Ue,M as Le}from"./ChangeMoversModal-C8eLZ_x-.js";import{T as Fe}from"./Button.vue_vue_type_style_index_0_scoped_39e4a762_lang-CqIf3uJT.js";const xe={class:"info-window"},Ie={class:"info-window-header"},Ne={class:"info-window-title"},Ve={class:"info-window-content"},Ae={key:0,class:"info-window-actions"},Se=A({__name:"MapInfoWindow",props:{title:{type:String,default:""},closable:{type:Boolean,default:!0}},emits:["close"],setup(R){return(c,t)=>(d(),p("div",xe,[o("div",Ie,[o("h3",Ne,_(R.title),1),R.closable?(d(),p("button",{key:0,onClick:t[0]||(t[0]=q=>c.$emit("close")),class:"close-button"},t[1]||(t[1]=[o("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z",fill:"currentColor"})],-1)]))):B("",!0)]),o("div",Ve,[J(c.$slots,"default",{},void 0,!0)]),c.$slots.actions?(d(),p("div",Ae,[J(c.$slots,"actions",{},void 0,!0)])):B("",!0)]))}}),Te=S(Se,[["__scopeId","data-v-634015c8"]]),De={class:"material-counter"},Be={class:"material-name"},Pe={class:"counter-controls"},Ee=["disabled"],Oe={class:"counter-value"},Ze=["disabled"],Ge=A({__name:"MaterialCounter",props:{name:{type:String,required:!0},initialCount:{type:Number,default:1},disabled:{type:Boolean,default:!1}},emits:["update:count"],setup(R,{emit:c}){const t=R,q=c,n=r(Math.max(1,t.initialCount));X(()=>{t.initialCount<1&&q("update:count",{name:t.name,count:1})}),N(()=>t.initialCount,y=>{n.value=Math.max(1,y)});const h=()=>{n.value++,q("update:count",{name:t.name,count:n.value})},i=()=>{n.value>1&&(n.value--,q("update:count",{name:t.name,count:n.value}))};return(y,f)=>(d(),p("div",De,[o("div",Be,_(R.name),1),o("div",Pe,[o("button",{class:"counter-btn",onClick:i,disabled:R.disabled||n.value<=1}," - ",8,Ee),o("span",Oe,_(n.value),1),o("button",{class:"counter-btn",onClick:h,disabled:R.disabled}," + ",8,Ze)])]))}}),We=S(Ge,[["__scopeId","data-v-f878a484"]]),ze={class:"add-material-form"},He={class:"form-group"},je={class:"action-buttons"},Ke=A({__name:"AddMaterialModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","add","cancel"],setup(R,{emit:c}){const t=R,q=c,n=r(t.show),h=r(""),i=r(!1);N(()=>t.show,b=>{n.value=b,b&&(h.value="",y())}),N(n,b=>{q("update:show",b)});const y=()=>{i.value=h.value.trim().length>0},f=()=>{n.value=!1,q("cancel")},m=()=>{i.value&&(q("add",h.value.trim()),n.value=!1)};return(b,w)=>(d(),V(Y,{modelValue:n.value,"onUpdate:modelValue":w[1]||(w[1]=M=>n.value=M),title:"Add material"},{default:g(()=>[o("div",ze,[o("div",He,[w[2]||(w[2]=o("label",null,"Material name",-1)),v(Fe,{modelValue:h.value,"onUpdate:modelValue":w[0]||(w[0]=M=>h.value=M),placeholder:"Type here",onInput:y},null,8,["modelValue"])]),o("div",je,[v(C,{type:"secondary","small-button":"true",onClick:f},{default:g(()=>w[3]||(w[3]=[k("Close")])),_:1}),v(C,{"small-button":"true",onClick:m,disabled:!i.value},{default:g(()=>w[4]||(w[4]=[k("Add")])),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),Qe=S(Ke,[["__scopeId","data-v-6bf8bab5"]]),Je={class:"unload-load-form"},Xe={class:"operation-buttons"},Ye={class:"cancel-button mt-4"},et=A({__name:"UnloadLoadModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","unload","load","cancel"],setup(R,{emit:c}){const t=R,q=c,n=r(t.modelValue);N(()=>t.modelValue,f=>{n.value=f}),N(n,f=>{q("update:modelValue",f)});const h=()=>{q("unload"),n.value=!1},i=()=>{q("load"),n.value=!1},y=()=>{q("cancel"),n.value=!1};return(f,m)=>(d(),V(Y,{show:n.value,"onUpdate:show":m[0]||(m[0]=b=>n.value=b),title:"Unload/Load"},{default:g(()=>[o("div",Je,[m[4]||(m[4]=o("div",{class:"status-message"},[o("p",null,"Select an operation to perform:")],-1)),o("div",Xe,[v(C,{"small-button":"true",onClick:h,class:"mb-3"},{default:g(()=>m[1]||(m[1]=[k(" Unload at current location ")])),_:1}),v(C,{"small-button":"true",onClick:i},{default:g(()=>m[2]||(m[2]=[k(" Load from current location ")])),_:1})]),o("div",Ye,[v(C,{type:"secondary","small-button":"true",onClick:y,"full-width":!0},{default:g(()=>m[3]||(m[3]=[k("Close")])),_:1})])])]),_:1},8,["show"]))}}),tt=S(et,[["__scopeId","data-v-db5e6d8e"]]),st={class:"tracking-view"},at={key:0,class:"flex items-center justify-center h-screen"},ot={key:1,class:"p-4"},lt={class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"},nt={key:2,class:"p-4"},it={key:3,class:"tracking-content"},rt={class:"map-wrapper"},ut={class:"map-container"},dt={class:"info-window-content"},ct={class:"text-lg font-semibold"},vt={class:"info-cards"},mt={class:"info-card"},ft={class:"info-value"},pt={class:"info-card"},gt={class:"info-value"},qt={key:0,class:"bottom-content flex"},ht={class:"overlay-content"},yt={class:"content-block"},wt={class:"address-list"},Rt={key:0,class:"content-block"},bt={class:"materials-grid"},kt={class:"action-buttons"},Ct={class:"secondary-buttons"},_t=A({__name:"TrackingView",setup(R){const c=_e(),t=qe(),q=he(),n=r(!1),h=r(!1),i=r(""),y=r(!1),f=r(!1),m=r(2),b=r(!1),w=r(!1),M=r(!1),P=r(!1);r(!1);const F=r(null),T=r(!0),ee=L(()=>{var e;return(e=t.selectedRequest)!=null&&e.departure_time?new Date(t.selectedRequest.departure_time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--"}),z=r("--:--"),te=r("--"),se=L(()=>{var a;const s=(a=t.selectedRequest)==null?void 0:a.addresses;if(!s||s.length===0)return null;const l=s.find(u=>u.type==="loading")||s[0];return{lat:parseFloat(l.latitude),lng:parseFloat(l.longitude)}}),ae=L(()=>{var a;const s=(a=t.selectedRequest)==null?void 0:a.addresses;if(!s||s.length===0)return null;const e=s.filter(u=>u.type==="unloading"),l=e.length>0?e[e.length-1]:s[s.length-1];return{lat:parseFloat(l.latitude),lng:parseFloat(l.longitude)}}),H=L(()=>{var s;return(s=t.selectedRequest)!=null&&s.addresses?t.selectedRequest.addresses.map(e=>({id:e.id||e.order,address:e.address,type:e.type,latitude:e.latitude,longitude:e.longitude,visited:!1})):[]}),E=L(()=>{var s;return(s=t.selectedRequest)!=null&&s.materials?t.selectedRequest.materials.map(e=>({id:e.id||Math.random(),name:e.name,count:Math.max(1,e.quantity||1)})):[]}),x=r({lat:40.7128,lng:-74.006}),oe=r(12),O=L(()=>{var s;return(s=t.selectedRequest)!=null&&s.addresses?t.selectedRequest.addresses.map(e=>{const l=e.type==="loading",a=parseFloat(e.latitude),u=parseFloat(e.longitude);return{position:{lat:isNaN(a)?40.7128:a,lng:isNaN(u)?-74.006:u},title:l?"Loading Point":"Unloading Point",icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${l?"#5D87EE":"#F97066"}">
            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
          </svg>
        `)},address:e.address,type:e.type}}):[]}),U=r(null),Z=r(!1),j=L(()=>y.value?f.value?"Continue":P.value?"Complete request":"Take a break":"Start moving"),K=async()=>{var s;if((s=t.selectedRequest)!=null&&s.id){n.value=!0;try{y.value?f.value?(await t.updateRequestStatus(t.selectedRequest.id,"active"),f.value=!1):P.value?await le():(await t.updateRequestStatus(t.selectedRequest.id,"break"),f.value=!0):(await t.updateRequestStatus(t.selectedRequest.id,"active"),y.value=!0)}catch(e){console.error("Action error:",e),i.value="Failed to update request status"}finally{n.value=!1}}},le=async()=>{var s;if((s=t.selectedRequest)!=null&&s.id)try{const e={status:"completed",materials:E.value.map(l=>({name:l.name,quantity:Math.max(1,l.count)}))};await t.updateRequest(t.selectedRequest.id,e),c.push("/")}catch(e){console.error("Complete request error:",e),i.value="Failed to complete request"}},ne=()=>{console.log("Opening change movers modal, current movers:",m.value),b.value=!0},ie=async s=>{var e;if(!((e=t.selectedRequest)!=null&&e.id)){console.error("No request selected for updating movers count");return}console.log(`Updating movers count to: ${s} for request: ${t.selectedRequest.id}`);try{n.value=!0,await t.updateMoversCount(t.selectedRequest.id,s)?(m.value=s,console.log("Movers count updated successfully")):(console.error("Failed to update movers count:",t.error),i.value=`Failed to update movers count: ${t.error||"Unknown error"}`)}catch(l){console.error("Update movers error:",l),i.value="Failed to update movers count"}finally{n.value=!1}},re=async s=>{var l;if(!((l=t.selectedRequest)!=null&&l.id)){console.error("No request selected for adding material");return}t.selectedRequest.materials||(t.selectedRequest.materials=[]),console.log(`Adding material: ${s}`);const e={name:s,quantity:1};t.selectedRequest.materials.push(e),console.log("Materials after adding locally:",t.selectedRequest.materials);try{h.value=!0;const a={materials:t.selectedRequest.materials.map($=>({name:$.name,quantity:$.quantity||1}))};await t.updateRequest(t.selectedRequest.id,a)?console.log("Material saved successfully to backend"):(console.error("Failed to save material to backend:",t.error),i.value=`Failed to save material: ${t.error||"Unknown error"}`)}catch(a){console.error("Error saving material:",a),i.value="Failed to save material. Please try again."}finally{h.value=!1}},ue=async({name:s,count:e})=>{var a,u;if(!((a=t.selectedRequest)!=null&&a.id)||!((u=t.selectedRequest)!=null&&u.materials)){console.error("No request selected for updating material");return}const l=t.selectedRequest.materials.find($=>$.name===s);if(l){const $=Math.max(1,e);l.quantity=$,console.log(`Updated material ${s} quantity to ${$}`),F.value&&clearTimeout(F.value),F.value=setTimeout(async()=>{try{h.value=!0;const I={materials:t.selectedRequest.materials.map(Q=>({name:Q.name,quantity:Q.quantity||1}))};await t.updateRequest(t.selectedRequest.id,I)?console.log("Material quantities saved successfully to backend"):(console.error("Failed to save material quantities to backend:",t.error),i.value=`Failed to save quantity changes: ${t.error||"Unknown error"}`)}catch(I){console.error("Error saving material quantities:",I),i.value="Failed to save quantity changes. Please try again."}finally{h.value=!1}},500)}},de=()=>{M.value=!0},ce=async()=>{var s;if(console.log("Unload operation triggered"),!!((s=t.selectedRequest)!=null&&s.id))try{P.value=!0,M.value=!1,console.log("Unloading completed at current location")}catch(e){console.error("Unload error:",e),i.value="Failed to mark unloading complete"}},ve=async()=>{var s;if(console.log("Load operation triggered"),!!((s=t.selectedRequest)!=null&&s.id))try{M.value=!1,console.log("Loading completed at current location")}catch(e){console.error("Load error:",e),i.value="Failed to mark loading complete"}},me=()=>{w.value=!0,console.log("Opening add material modal")},fe=s=>{U.value=s,Z.value=!0},pe=()=>{Z.value=!1,U.value=null},ge=s=>{if(s&&s.duration&&s.distance){const e=Math.round(s.duration/60),l=Math.floor(e/60),a=e%60;z.value=l>0?`${l}h ${a}m`:`${a}m`;const u=(s.distance/1e3).toFixed(1);te.value=`${u} km`}};return X(async()=>{var s,e;if(!q.isAuthenticated){c.push("/");return}n.value=!0,i.value="";try{let l=Number(c.currentRoute.value.query.id);if(console.log("TrackingView mounted with query ID:",l),!l&&((s=t.selectedRequest)!=null&&s.id)&&(l=t.selectedRequest.id,console.log(`No ID in URL, using ID from store: ${l}`),c.replace({path:"/tracking",query:{id:l.toString()}})),!l){i.value="No request ID provided. Please select a request first.",console.error("No request ID in URL or store"),n.value=!1;return}if(!t.selectedRequest||t.selectedRequest.id!==l){if(console.log(`Loading request with ID: ${l}`),!await t.getRequestById(l)||!t.selectedRequest){i.value=`Failed to load request #${l}. ${t.error||"Unknown error"}`,console.error("Failed to load request:",t.error),n.value=!1;return}}else console.log("Request already loaded in store:",t.selectedRequest);const a=t.selectedRequest.status||"pending";if(console.log(`Request status: ${a}`),a==="confirmed"?(y.value=!1,f.value=!1):a==="active"?(y.value=!0,f.value=!1):a==="break"&&(y.value=!0,f.value=!0),((e=t.selectedRequest.addresses)==null?void 0:e.length)>0){const u=t.selectedRequest.addresses[0],$=parseFloat(u.latitude),I=parseFloat(u.longitude);!isNaN($)&&!isNaN(I)?(x.value={lat:$,lng:I},console.log("Map center set to:",x.value)):(console.warn("Invalid coordinates, using default map center"),x.value={lat:40.7128,lng:-74.006})}else console.warn("Request has no addresses, using default map center"),x.value={lat:40.7128,lng:-74.006};m.value=t.selectedRequest.movers_count||2,console.log(`Number of movers: ${m.value}`)}catch(l){console.error("Init tracking error:",l),i.value="An error occurred while loading the request"}finally{n.value=!1}}),N(()=>{var s;return(s=t.selectedRequest)==null?void 0:s.status},(s,e)=>{var l;if(s!==e&&((l=t.selectedRequest)!=null&&l.id)){const a=c.currentRoute.value.query.id,u=t.selectedRequest.id.toString();a!==u&&(console.log(`Updating URL with request ID: ${u}`),c.replace({path:"/tracking",query:{id:u}}))}}),ye(()=>{if(O.value.length>0&&!U.value){const s=O.value[0];s&&s.position&&(x.value={lat:parseFloat(s.position.lat)||40.7128,lng:parseFloat(s.position.lng)||-74.006})}}),we(()=>{F.value&&(clearTimeout(F.value),F.value=null)}),(s,e)=>{var l;return d(),p("div",st,[v(Re,{title:`Request ${((l=D(t).selectedRequest)==null?void 0:l.id)||""}`},null,8,["title"]),n.value?(d(),p("main",at,e[9]||(e[9]=[o("p",null,"Loading tracking data...",-1)]))):i.value?(d(),p("main",ot,[o("div",lt,[o("p",null,_(i.value),1)]),v(C,{onClick:e[0]||(e[0]=a=>D(c).push("/"))},{default:g(()=>e[10]||(e[10]=[k(" Return to Requests ")])),_:1})])):D(t).selectedRequest?(d(),p("main",it,[o("div",rt,[o("div",ut,[v($e,{center:x.value,zoom:oe.value,height:"100%","show-route":!0,origin:se.value,destination:ae.value,onRouteCalculated:ge},{default:g(()=>[(d(!0),p(G,null,W(O.value,a=>(d(),V(Le,{key:a.title,position:a.position,icon:a.icon,onClick:u=>fe(a)},null,8,["position","icon","onClick"]))),128)),Z.value&&U.value?(d(),V(Te,{key:0,position:U.value.position,onClose:pe},{default:g(()=>[o("div",dt,[o("h3",ct,_(U.value.title),1),o("p",null,_(U.value.address),1)])]),_:1},8,["position"])):B("",!0)]),_:1},8,["center","zoom","origin","destination"])]),o("div",vt,[o("div",mt,[e[13]||(e[13]=o("span",{class:"info-label"},"Departure time",-1)),o("span",ft,_(ee.value),1)]),o("div",pt,[e[14]||(e[14]=o("span",{class:"info-label"},"Travel time",-1)),o("span",gt,_(z.value),1)])]),y.value?(d(),p("div",{key:1,class:be(["bottom-overlay",{collapsed:!T.value}])},[o("div",{class:"drag-handle",onClick:e[2]||(e[2]=a=>T.value=!T.value)},e[15]||(e[15]=[o("div",{class:"handle-bar"},null,-1)])),ke(o("div",ht,[o("div",yt,[e[16]||(e[16]=o("h3",{class:"block-title"},"Unloading point",-1)),o("div",wt,[(d(!0),p(G,null,W(H.value,(a,u)=>(d(),p("div",{key:a.id,class:"address-item"},_(a.address),1))),128))])]),E.value.length>0?(d(),p("div",Rt,[e[17]||(e[17]=o("h3",{class:"block-title"},"Used materials",-1)),o("div",bt,[(d(!0),p(G,null,W(E.value,a=>(d(),V(We,{key:a.id,name:a.name,initialCount:a.count,"onUpdate:count":ue},null,8,["name","initialCount"]))),128))])])):B("",!0),o("div",kt,[v(C,{onClick:K,disabled:n.value,"full-width":!0,class:"take-break-button"},{default:g(()=>[k(_(j.value),1)]),_:1},8,["disabled"]),o("div",Ct,[v(C,{onClick:me,disabled:h.value,class:"secondary-btn"},{default:g(()=>e[18]||(e[18]=[k(" Add materials ")])),_:1},8,["disabled"]),v(C,{onClick:de,disabled:f.value,class:"secondary-btn"},{default:g(()=>e[19]||(e[19]=[k(" Unload/Load ")])),_:1},8,["disabled"])]),v(C,{onClick:ne,"full-width":!0,class:"change-movers-btn"},{default:g(()=>e[20]||(e[20]=[k(" Change number of movers ")])),_:1})])],512),[[Ce,T.value]])],2)):(d(),p("div",qt,[v(C,{onClick:K,disabled:n.value,"full-width":!0,class:"start-button"},{default:g(()=>[k(_(j.value),1)]),_:1},8,["disabled"])]))])])):(d(),p("main",nt,[e[12]||(e[12]=o("p",null,"No request selected. Please select a request first.",-1)),v(C,{onClick:e[1]||(e[1]=a=>D(c).push("/")),class:"mt-4"},{default:g(()=>e[11]||(e[11]=[k(" Return to Requests ")])),_:1})])),v(Ue,{show:b.value,"onUpdate:show":e[3]||(e[3]=a=>b.value=a),initialCount:m.value,onConfirm:ie,onCancel:e[4]||(e[4]=a=>b.value=!1)},null,8,["show","initialCount"]),v(Qe,{show:w.value,"onUpdate:show":e[5]||(e[5]=a=>w.value=a),onAdd:re,onCancel:e[6]||(e[6]=a=>w.value=!1)},null,8,["show"]),v(tt,{show:M.value,"onUpdate:show":e[7]||(e[7]=a=>M.value=a),addresses:H.value,onUnload:ce,onLoad:ve,onCancel:e[8]||(e[8]=a=>M.value=!1)},null,8,["show","addresses"]),v(Me)])}}}),Ft=S(_t,[["__scopeId","data-v-da9f6d1e"]]);export{Ft as default};
