import{d as V,o as d,a as g,e as o,t as M,f as P,a1 as ee,_ as D,r,U as te,a2 as S,X as I,h as q,a3 as se,b as v,i as _,G as C,R as be,u as ke,c as F,a4 as _e,a5 as Ce,V as A,H as Me,Z as $e,g as Ue,a6 as Fe,a7 as H,a8 as j,j as Le,a9 as Ne,F as xe}from"./index-wW9rBK64.js";import{G as Se,C as Ae,M as Ie}from"./ChangeMoversModal-DxJHIazD.js";import{T as Ve}from"./Button.vue_vue_type_style_index_0_scoped_39e4a762_lang-BnSR8He6.js";const De={class:"info-window"},Te={class:"info-window-header"},Be={class:"info-window-title"},Pe={class:"info-window-content"},Ee={key:0,class:"info-window-actions"},Oe=V({__name:"MapInfoWindow",props:{title:{type:String,default:""},closable:{type:Boolean,default:!0}},emits:["close"],setup(b){return(c,t)=>(d(),g("div",De,[o("div",Te,[o("h3",Be,M(b.title),1),b.closable?(d(),g("button",{key:0,onClick:t[0]||(t[0]=h=>c.$emit("close")),class:"close-button"},t[1]||(t[1]=[o("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z",fill:"currentColor"})],-1)]))):P("",!0)]),o("div",Pe,[ee(c.$slots,"default",{},void 0,!0)]),c.$slots.actions?(d(),g("div",Ee,[ee(c.$slots,"actions",{},void 0,!0)])):P("",!0)]))}}),Ze=D(Oe,[["__scopeId","data-v-634015c8"]]),Ge={class:"material-counter"},We={class:"material-name"},ze={class:"counter-controls"},He=["disabled"],je={class:"counter-value"},Ke=["disabled"],Qe=V({__name:"MaterialCounter",props:{name:{type:String,required:!0},initialCount:{type:Number,default:1},disabled:{type:Boolean,default:!1}},emits:["update:count"],setup(b,{emit:c}){const t=b,h=c,n=r(Math.max(1,t.initialCount));te(()=>{t.initialCount<1&&h("update:count",{name:t.name,count:1})}),S(()=>t.initialCount,p=>{n.value=Math.max(1,p)});const y=()=>{n.value++,h("update:count",{name:t.name,count:n.value})},u=()=>{n.value>1&&(n.value--,h("update:count",{name:t.name,count:n.value}))};return(p,m)=>(d(),g("div",Ge,[o("div",We,M(b.name),1),o("div",ze,[o("button",{class:"counter-btn",onClick:u,disabled:b.disabled||n.value<=1}," - ",8,He),o("span",je,M(n.value),1),o("button",{class:"counter-btn",onClick:y,disabled:b.disabled}," + ",8,Ke)])]))}}),Xe=D(Qe,[["__scopeId","data-v-f878a484"]]),Je={class:"add-material-form"},Ye={class:"form-group"},et={class:"action-buttons"},tt=V({__name:"AddMaterialModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","add","cancel"],setup(b,{emit:c}){const t=b,h=c,n=r(t.show),y=r(""),u=r(!1);S(()=>t.show,k=>{n.value=k,k&&(y.value="",p())}),S(n,k=>{h("update:show",k)});const p=()=>{u.value=y.value.trim().length>0},m=()=>{n.value=!1,h("cancel")},f=()=>{u.value&&(h("add",y.value.trim()),n.value=!1)};return(k,R)=>(d(),I(se,{modelValue:n.value,"onUpdate:modelValue":R[1]||(R[1]=$=>n.value=$),title:"Add material"},{default:q(()=>[o("div",Je,[o("div",Ye,[R[2]||(R[2]=o("label",null,"Material name",-1)),v(Ve,{modelValue:y.value,"onUpdate:modelValue":R[0]||(R[0]=$=>y.value=$),placeholder:"Type here",onInput:p},null,8,["modelValue"])]),o("div",et,[v(C,{type:"secondary","small-button":"true",onClick:m},{default:q(()=>R[3]||(R[3]=[_("Close")])),_:1}),v(C,{"small-button":"true",onClick:f,disabled:!u.value},{default:q(()=>R[4]||(R[4]=[_("Add")])),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),st=D(tt,[["__scopeId","data-v-6bf8bab5"]]),at={class:"unload-load-form"},lt={class:"operation-buttons"},ot={class:"cancel-button mt-4"},nt=V({__name:"UnloadLoadModal",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","unload","load","cancel"],setup(b,{emit:c}){const t=b,h=c,n=r(t.modelValue);S(()=>t.modelValue,m=>{n.value=m}),S(n,m=>{h("update:modelValue",m)});const y=()=>{h("unload"),n.value=!1},u=()=>{h("load"),n.value=!1},p=()=>{h("cancel"),n.value=!1};return(m,f)=>(d(),I(se,{show:n.value,"onUpdate:show":f[0]||(f[0]=k=>n.value=k),title:"Unload/Load"},{default:q(()=>[o("div",at,[f[4]||(f[4]=o("div",{class:"status-message"},[o("p",null,"Select an operation to perform:")],-1)),o("div",lt,[v(C,{"small-button":"true",onClick:y,class:"mb-3"},{default:q(()=>f[1]||(f[1]=[_(" Unload at current location ")])),_:1}),v(C,{"small-button":"true",onClick:u},{default:q(()=>f[2]||(f[2]=[_(" Load from current location ")])),_:1})]),o("div",ot,[v(C,{type:"secondary","small-button":"true",onClick:p,"full-width":!0},{default:q(()=>f[3]||(f[3]=[_("Close")])),_:1})])])]),_:1},8,["show"]))}}),ut=D(nt,[["__scopeId","data-v-db5e6d8e"]]),it={class:"tracking-view"},rt={key:0,class:"flex items-center justify-center h-screen"},dt={key:1,class:"p-4"},ct={class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"},vt={key:2,class:"p-4"},mt={key:3,class:"tracking-content"},ft={class:"request-selector-container"},pt={class:"map-wrapper"},gt={class:"map-container"},qt={class:"info-window-content"},ht={class:"text-lg font-semibold"},yt={class:"info-cards"},Rt={class:"info-card"},wt={class:"info-value"},bt={class:"info-card"},kt={class:"info-value"},_t={key:0,class:"bottom-content flex"},Ct={class:"overlay-content"},Mt={class:"content-block"},$t={class:"address-list"},Ut={key:0,class:"content-block"},Ft={class:"materials-grid"},Lt={class:"action-buttons"},Nt={class:"secondary-buttons"},xt=V({__name:"TrackingView",setup(b){const c=Le(),t=be(),h=ke(),n=r(!1),y=r(!1),u=r(""),p=r(!1),m=r(!1),f=r(2),k=r(!1),R=r(!1),$=r(!1),E=r(!1);r(!1);const x=r(null),T=r(!0),B=r(null),O=r([]),ae=F(()=>{var e;return(e=t.selectedRequest)!=null&&e.departure_time?new Date(t.selectedRequest.departure_time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--"}),K=r("--:--"),le=r("--"),oe=F(()=>{var a;const s=(a=t.selectedRequest)==null?void 0:a.addresses;if(!s||s.length===0)return null;const l=s.find(i=>i.type==="loading")||s[0];return{lat:parseFloat(l.latitude),lng:parseFloat(l.longitude)}}),ne=F(()=>{var a;const s=(a=t.selectedRequest)==null?void 0:a.addresses;if(!s||s.length===0)return null;const e=s.filter(i=>i.type==="unloading"),l=e.length>0?e[e.length-1]:s[s.length-1];return{lat:parseFloat(l.latitude),lng:parseFloat(l.longitude)}}),Q=F(()=>{var s;return(s=t.selectedRequest)!=null&&s.addresses?t.selectedRequest.addresses.map(e=>({id:e.id||e.order,address:e.address,type:e.type,latitude:e.latitude,longitude:e.longitude,visited:!1})):[]}),Z=F(()=>{var s;return(s=t.selectedRequest)!=null&&s.materials?t.selectedRequest.materials.map(e=>({id:e.id||Math.random(),name:e.name,count:Math.max(1,e.quantity||1)})):[]}),L=r({lat:40.7128,lng:-74.006}),ue=r(12),G=F(()=>{var s;return(s=t.selectedRequest)!=null&&s.addresses?t.selectedRequest.addresses.map(e=>{const l=e.type==="loading",a=parseFloat(e.latitude),i=parseFloat(e.longitude);return{position:{lat:isNaN(a)?40.7128:a,lng:isNaN(i)?-74.006:i},title:l?"Loading Point":"Unloading Point",icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${l?"#5D87EE":"#F97066"}">
            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
          </svg>
        `)},address:e.address,type:e.type}}):[]}),N=r(null),W=r(!1),X=F(()=>p.value?m.value?"Continue":E.value?"Complete request":"Take a break":"Start moving"),ie=F(()=>O.value.map(s=>{const l=new Date(s.departure_time).toLocaleDateString();return{label:`Request #${s.id} - ${s.property_type} - ${l}`,value:s.id}})),J=async()=>{var s;if((s=t.selectedRequest)!=null&&s.id){n.value=!0;try{p.value?m.value?(await t.updateRequestStatus(t.selectedRequest.id,"active"),m.value=!1):E.value?await re():(await t.updateRequestStatus(t.selectedRequest.id,"break"),m.value=!0):(await t.updateRequestStatus(t.selectedRequest.id,"active"),p.value=!0)}catch(e){console.error("Action error:",e),u.value="Failed to update request status"}finally{n.value=!1}}},re=async()=>{var s;if((s=t.selectedRequest)!=null&&s.id)try{const e={status:"completed",materials:Z.value.map(l=>({name:l.name,quantity:Math.max(1,l.count)}))};await t.updateRequest(t.selectedRequest.id,e),c.push("/")}catch(e){console.error("Complete request error:",e),u.value="Failed to complete request"}},de=()=>{console.log("Opening change movers modal, current movers:",f.value),k.value=!0},ce=async s=>{var e;if(!((e=t.selectedRequest)!=null&&e.id)){console.error("No request selected for updating movers count");return}console.log(`Updating movers count to: ${s} for request: ${t.selectedRequest.id}`);try{n.value=!0,await t.updateMoversCount(t.selectedRequest.id,s)?(f.value=s,console.log("Movers count updated successfully")):(console.error("Failed to update movers count:",t.error),u.value=`Failed to update movers count: ${t.error||"Unknown error"}`)}catch(l){console.error("Update movers error:",l),u.value="Failed to update movers count"}finally{n.value=!1}},ve=async s=>{var l;if(!((l=t.selectedRequest)!=null&&l.id)){console.error("No request selected for adding material");return}t.selectedRequest.materials||(t.selectedRequest.materials=[]),console.log(`Adding material: ${s}`);const e={name:s,quantity:1};t.selectedRequest.materials.push(e),console.log("Materials after adding locally:",t.selectedRequest.materials);try{y.value=!0;const a={materials:t.selectedRequest.materials.map(w=>({name:w.name,quantity:w.quantity||1}))};await t.updateRequest(t.selectedRequest.id,a)?console.log("Material saved successfully to backend"):(console.error("Failed to save material to backend:",t.error),u.value=`Failed to save material: ${t.error||"Unknown error"}`)}catch(a){console.error("Error saving material:",a),u.value="Failed to save material. Please try again."}finally{y.value=!1}},me=async({name:s,count:e})=>{var a,i;if(!((a=t.selectedRequest)!=null&&a.id)||!((i=t.selectedRequest)!=null&&i.materials)){console.error("No request selected for updating material");return}const l=t.selectedRequest.materials.find(w=>w.name===s);if(l){const w=Math.max(1,e);l.quantity=w,console.log(`Updated material ${s} quantity to ${w}`),x.value&&clearTimeout(x.value),x.value=setTimeout(async()=>{try{y.value=!0;const U={materials:t.selectedRequest.materials.map(Y=>({name:Y.name,quantity:Y.quantity||1}))};await t.updateRequest(t.selectedRequest.id,U)?console.log("Material quantities saved successfully to backend"):(console.error("Failed to save material quantities to backend:",t.error),u.value=`Failed to save quantity changes: ${t.error||"Unknown error"}`)}catch(U){console.error("Error saving material quantities:",U),u.value="Failed to save quantity changes. Please try again."}finally{y.value=!1}},500)}},fe=()=>{$.value=!0},pe=async()=>{var s;if(console.log("Unload operation triggered"),!!((s=t.selectedRequest)!=null&&s.id))try{E.value=!0,$.value=!1,console.log("Unloading completed at current location")}catch(e){console.error("Unload error:",e),u.value="Failed to mark unloading complete"}},ge=async()=>{var s;if(console.log("Load operation triggered"),!!((s=t.selectedRequest)!=null&&s.id))try{$.value=!1,console.log("Loading completed at current location")}catch(e){console.error("Load error:",e),u.value="Failed to mark loading complete"}},qe=()=>{R.value=!0,console.log("Opening add material modal")},he=s=>{N.value=s,W.value=!0},ye=()=>{W.value=!1,N.value=null},Re=s=>{if(s&&s.duration&&s.distance){const e=Math.round(s.duration/60),l=Math.floor(e/60),a=e%60;K.value=l>0?`${l}h ${a}m`:`${a}m`;const i=(s.distance/1e3).toFixed(1);le.value=`${i} km`}},we=async s=>{var e,l;if(!(!s||s===((e=t.selectedRequest)==null?void 0:e.id))){n.value=!0,u.value="";try{if(!await t.getRequestById(s)||!t.selectedRequest){u.value=`Failed to load request #${s}`,n.value=!1;return}c.replace({path:"/tracking",query:{id:s.toString()}}),B.value=s;const i=t.selectedRequest.status||"pending";if(i==="confirmed"?(p.value=!1,m.value=!1):i==="active"?(p.value=!0,m.value=!1):i==="break"&&(p.value=!0,m.value=!0),((l=t.selectedRequest.addresses)==null?void 0:l.length)>0){const w=t.selectedRequest.addresses[0],U=parseFloat(w.latitude),z=parseFloat(w.longitude);!isNaN(U)&&!isNaN(z)&&(L.value={lat:U,lng:z})}f.value=t.selectedRequest.movers_count||2}catch(a){console.error("Error changing request:",a),u.value="Failed to load selected request"}finally{n.value=!1}}};return te(async()=>{var s,e;if(!h.isAuthenticated){c.push("/");return}n.value=!0,u.value="";try{await t.fetchRequests(),O.value=t.requests||[],console.log("Loaded user requests:",O.value.length);let l=Number(c.currentRoute.value.query.id);if(console.log("TrackingView mounted with query ID:",l),!l&&((s=t.selectedRequest)!=null&&s.id)&&(l=t.selectedRequest.id,console.log(`No ID in URL, using ID from store: ${l}`),c.replace({path:"/tracking",query:{id:l.toString()}})),!l){u.value="No request ID provided. Please select a request first.",console.error("No request ID in URL or store"),n.value=!1;return}if(!t.selectedRequest||t.selectedRequest.id!==l){if(console.log(`Loading request with ID: ${l}`),!await t.getRequestById(l)||!t.selectedRequest){u.value=`Failed to load request #${l}. ${t.error||"Unknown error"}`,console.error("Failed to load request:",t.error),n.value=!1;return}}else console.log("Request already loaded in store:",t.selectedRequest);const a=t.selectedRequest.status||"pending";if(console.log(`Request status: ${a}`),a==="confirmed"?(p.value=!1,m.value=!1):a==="active"?(p.value=!0,m.value=!1):a==="break"&&(p.value=!0,m.value=!0),((e=t.selectedRequest.addresses)==null?void 0:e.length)>0){const i=t.selectedRequest.addresses[0],w=parseFloat(i.latitude),U=parseFloat(i.longitude);!isNaN(w)&&!isNaN(U)?(L.value={lat:w,lng:U},console.log("Map center set to:",L.value)):(console.warn("Invalid coordinates, using default map center"),L.value={lat:40.7128,lng:-74.006})}else console.warn("Request has no addresses, using default map center"),L.value={lat:40.7128,lng:-74.006};f.value=t.selectedRequest.movers_count||2,console.log(`Number of movers: ${f.value}`),B.value=t.selectedRequest.id}catch(l){console.error("Init tracking error:",l),u.value="An error occurred while loading the request"}finally{n.value=!1}}),S(()=>{var s;return(s=t.selectedRequest)==null?void 0:s.status},(s,e)=>{var l;if(s!==e&&((l=t.selectedRequest)!=null&&l.id)){const a=c.currentRoute.value.query.id,i=t.selectedRequest.id.toString();a!==i&&(console.log(`Updating URL with request ID: ${i}`),c.replace({path:"/tracking",query:{id:i}}))}}),_e(()=>{if(G.value.length>0&&!N.value){const s=G.value[0];s&&s.position&&(L.value={lat:parseFloat(s.position.lat)||40.7128,lng:parseFloat(s.position.lng)||-74.006})}}),Ce(()=>{x.value&&(clearTimeout(x.value),x.value=null)}),(s,e)=>{var l;return d(),g("div",it,[v(Me,{title:`Request ${((l=A(t).selectedRequest)==null?void 0:l.id)||""}`},null,8,["title"]),n.value?(d(),g("main",rt,e[10]||(e[10]=[o("p",null,"Loading tracking data...",-1)]))):u.value?(d(),g("main",dt,[o("div",ct,[o("p",null,M(u.value),1)]),v(C,{onClick:e[0]||(e[0]=a=>A(c).push("/"))},{default:q(()=>e[11]||(e[11]=[_(" Return to Requests ")])),_:1})])):A(t).selectedRequest?(d(),g("main",mt,[o("div",ft,[v(A(Ne),{value:B.value,"onUpdate:value":[e[2]||(e[2]=a=>B.value=a),we],options:ie.value,placeholder:"Select a request",disabled:n.value,class:"request-selector"},null,8,["value","options","disabled"])]),o("div",pt,[o("div",gt,[v(Se,{center:L.value,zoom:ue.value,height:"100%","show-route":!0,origin:oe.value,destination:ne.value,onRouteCalculated:Re},{default:q(()=>[(d(!0),g(H,null,j(G.value,a=>(d(),I(Ie,{key:a.title,position:a.position,icon:a.icon,onClick:i=>he(a)},null,8,["position","icon","onClick"]))),128)),W.value&&N.value?(d(),I(Ze,{key:0,position:N.value.position,onClose:ye},{default:q(()=>[o("div",qt,[o("h3",ht,M(N.value.title),1),o("p",null,M(N.value.address),1)])]),_:1},8,["position"])):P("",!0)]),_:1},8,["center","zoom","origin","destination"])]),o("div",yt,[o("div",Rt,[e[14]||(e[14]=o("span",{class:"info-label"},"Departure time",-1)),o("span",wt,M(ae.value),1)]),o("div",bt,[e[15]||(e[15]=o("span",{class:"info-label"},"Travel time",-1)),o("span",kt,M(K.value),1)])]),p.value?(d(),g("div",{key:1,class:$e(["bottom-overlay",{collapsed:!T.value}])},[o("div",{class:"drag-handle",onClick:e[3]||(e[3]=a=>T.value=!T.value)},e[16]||(e[16]=[o("div",{class:"handle-bar"},null,-1)])),Ue(o("div",Ct,[o("div",Mt,[e[17]||(e[17]=o("h3",{class:"block-title"},"Unloading point",-1)),o("div",$t,[(d(!0),g(H,null,j(Q.value,(a,i)=>(d(),g("div",{key:a.id,class:"address-item"},M(a.address),1))),128))])]),Z.value.length>0?(d(),g("div",Ut,[e[18]||(e[18]=o("h3",{class:"block-title"},"Used materials",-1)),o("div",Ft,[(d(!0),g(H,null,j(Z.value,a=>(d(),I(Xe,{key:a.id,name:a.name,initialCount:a.count,"onUpdate:count":me},null,8,["name","initialCount"]))),128))])])):P("",!0),o("div",Lt,[v(C,{onClick:J,disabled:n.value,"full-width":!0,class:"take-break-button"},{default:q(()=>[_(M(X.value),1)]),_:1},8,["disabled"]),o("div",Nt,[v(C,{onClick:qe,disabled:y.value,class:"secondary-btn"},{default:q(()=>e[19]||(e[19]=[_(" Add materials ")])),_:1},8,["disabled"]),v(C,{onClick:fe,disabled:m.value,class:"secondary-btn"},{default:q(()=>e[20]||(e[20]=[_(" Unload/Load ")])),_:1},8,["disabled"])]),v(C,{onClick:de,"full-width":!0,class:"change-movers-btn"},{default:q(()=>e[21]||(e[21]=[_(" Change number of movers ")])),_:1})])],512),[[Fe,T.value]])],2)):(d(),g("div",_t,[v(C,{onClick:J,disabled:n.value,"full-width":!0,class:"start-button"},{default:q(()=>[_(M(X.value),1)]),_:1},8,["disabled"])]))])])):(d(),g("main",vt,[e[13]||(e[13]=o("p",null,"No request selected. Please select a request first.",-1)),v(C,{onClick:e[1]||(e[1]=a=>A(c).push("/")),class:"mt-4"},{default:q(()=>e[12]||(e[12]=[_(" Return to Requests ")])),_:1})])),v(Ae,{show:k.value,"onUpdate:show":e[4]||(e[4]=a=>k.value=a),initialCount:f.value,onConfirm:ce,onCancel:e[5]||(e[5]=a=>k.value=!1)},null,8,["show","initialCount"]),v(st,{show:R.value,"onUpdate:show":e[6]||(e[6]=a=>R.value=a),onAdd:ve,onCancel:e[7]||(e[7]=a=>R.value=!1)},null,8,["show"]),v(ut,{show:$.value,"onUpdate:show":e[8]||(e[8]=a=>$.value=a),addresses:Q.value,onUnload:pe,onLoad:ge,onCancel:e[9]||(e[9]=a=>$.value=!1)},null,8,["show","addresses"]),v(xe)])}}}),Vt=D(xt,[["__scopeId","data-v-bb0cf057"]]);export{Vt as default};
